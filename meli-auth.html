<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login Mercado Libre (PKCE)</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    button { padding: 0.6rem 1.2rem; font-size: 1rem; }
    pre { background: #f0f0f0; padding: 1rem; margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Autenticaci√≥n con Mercado Libre (PKCE)</h1>
  <button onclick="startAuth()">Iniciar autenticaci√≥n</button>
  <pre id="info">Esperando acci√≥n...</pre>

  <script>
    const clientId = '7427123709053353';
    const redirectUri = 'https://meli-test-frontend.netlify.app';

    function base64URLEncode(str) {
      return btoa(String.fromCharCode(...new Uint8Array(str)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return base64URLEncode(hash);
    }

    async function startAuth() {
      const verifier = [...crypto.getRandomValues(new Uint8Array(64))]
        .map(x => ('0' + x.toString(16)).slice(-2)).join('');
      const challenge = await sha256(verifier);
      localStorage.setItem('meli_code_verifier', verifier);
      console.log("üîê code_verifier:", verifier);

      const authUrl = `https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge=${challenge}&code_challenge_method=S256`;
      window.location.href = authUrl;
    }

    async function exchangeCodeForToken(code) {
      const verifier = localStorage.getItem('meli_code_verifier');
      if (!verifier) {
        document.getElementById("info").innerText = "‚ùå No se encontr√≥ el code_verifier en localStorage.";
        return;
      }

      const params = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: clientId,
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier
      });

      const response = await fetch('https://api.mercadolibre.com/oauth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });

      const data = await response.json();
      console.log("‚úÖ Access Token:", data.access_token);
      document.getElementById("info").textContent = JSON.stringify(data, null, 2);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    if (code) {
      document.getElementById("info").innerText = "üîÑ Intercambiando code por token...";
      exchangeCodeForToken(code);
    }
  </script>
</body>
</html>
